template: true
valuesFilePath: ../values.yml

{{ $IS_PRERELEASE_BRANCHES  := ternary true false (or (hasPrefix "preRelease" "{{gitBranch}}") (hasPrefix "milestone" "{{gitBranch}}")) }}

resources:
  {{ if $IS_PRERELEASE_BRANCHES }}
  - name: buildplanePreReleaseGit
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/.+\b
  {{ end }}      

  - name: u18AMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/aws\/x86_64\/Ubuntu_18.04\/.+\b

  - name: u18GCPGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/gcp\/x86_64\/Ubuntu_18.04\/.+\b

  - name: u18AzureMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/azure\/x86_64\/Ubuntu_18.04\/.+\b

  - name: u20AMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/aws\/x86_64\/Ubuntu_20.04\/.+\b

  - name: customAMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/azure\/x86_64\/TestCustom_u20\/.+\b

  - name: u20GCPGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/gcp\/x86_64\/Ubuntu_20.04\/.+\b

  - name: u20AzureMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/azure\/x86_64\/Ubuntu_20.04\/.+\b

  - name: c7AMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/aws\/x86_64\/CentOS_7\/.+\b

  - name: c7GCPGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/gcp\/x86_64\/CentOS_7\/.+\b

  - name: c7AzureMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/azure\/x86_64\/CentOS_7\/.+\b

  - name: m13AMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/ami\/x86_64\/MacOS_13.5\/.+\b

  - name: w19AzureMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/azure\/x86_64\/WindowsServer_2019\/.+\b

  - name: w19AMIGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/aws\/x86_64\/WindowsServer_2019\/.+\b

  - name: ootbExtensionsFS_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/extensions/extensions-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: nodeInitGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/nodeInit\/.+\b

  - name: nodeInitFS_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/nodeInit/nodeInit-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: infraGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/infra\/.+\b

  - name: reqKickGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      # Remove cloneProtocol after PIPE-11156 is fixed
      cloneProtocol: https
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/(images\/reqkick|reqKick\/).*

  - name: controlplane_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \b(tools\/ms-testing-library|packages\/types|buildplane\/(images\/reqkick|reqKick\/)).*

  - name: reqKickFS_x8664_U18_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-Ubuntu_18.04-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_x8664_U20_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-Ubuntu_20.04-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_arm64_U20_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-ARM64-Ubuntu_20.04-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_x8664_C7_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-CentOS_7-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_x8664_RHEL7_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-RHEL_7-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_x8664_RHEL8_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-RHEL_8-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_x86_64_AmazonLinux2_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-AmazonLinux_2-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_x8664_W19_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-WindowsServer_2019-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_x8664_MacOS13_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-x86_64-MacOS_13.5-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reqKickFS_arm64_MacOS12_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-ARM64-MacOS_12-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/reports\/.+\b

  - name: pipeGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/pipe\/.+\b

  - name: dindGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/images\/dind\/.+\b

  - name: reportsFS_x8664_U18_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-Ubuntu_18.04-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsFS_x8664_U20_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-Ubuntu_20.04-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsFS_arm64_U20_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-ARM64-Ubuntu_20.04-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  {{- range $build := $.Values.build }}
    {{- range $build.arch }}
    
  - name: reqKickFS_{{ .name }}_{{ $build.alias }}
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reqKick/reqKick-{{ .name }}-{{ $build.os }}-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsFS_{{ .name }}_{{ $build.alias }}
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-{{ .name }}-{{ $build.os }}-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneDebFS_{{ .name }}_{{ $build.alias }}
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-{{ .name }}-{{ $build.os }}-*.deb"
      props: vcs.branch={{gitBranch}}
      recursive: false

    {{- end}}

  {{- end}}
  - name: reportsFS_x8664_C7_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-CentOS_7-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsFS_x8664_RHEL7_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-RHEL_7-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsFS_x8664_RHEL8_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-RHEL_8-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false
  - name: reportsFS_x86_64_AmazonLinux2_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-AmazonLinux_2-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false
  - name: reportsFS_x8664_W19_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-WindowsServer_2019-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsFS_x8664_MacOS13_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-x86_64-MacOS_13.5-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: reportsFS_arm64_MacOS12_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/reports/reports-ARM64-MacOS_12-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: pipeFS_arm64_darwin_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/pipe/pipe-*-darwin-arm64"
      props: vcs.branch={{gitBranch}}
      recursive: false
      flat: true
  - name: pipeFS_amd64_darwin_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/pipe/pipe-*-darwin-amd64"
      props: vcs.branch={{gitBranch}}
      recursive: false
      flat: true
  - name: pipeFS_amd64_linux_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/pipe/pipe-*-linux-amd64"
      props: vcs.branch={{gitBranch}}
      recursive: false
      flat: true
  - name: pipeFS_arm64_linux_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/pipe/pipe-*-linux-arm64"
      props: vcs.branch={{gitBranch}}
      recursive: false
      flat: true
  - name: pipeFS_amd64_windows_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/pipe/pipe-*-windows-amd64"
      props: vcs.branch={{gitBranch}}
      recursive: false
      flat: true

  - name: buildGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/build\/.+\b

  - name: coreGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bpackages\/core\/.+\b

  - name: extensionsGit_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuildplane\/build\/extensions\/.+\b

  - name: buildPlaneDebFS_x8664_U18_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-Ubuntu_18.04-*.deb"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneDebFS_x8664_U20_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-Ubuntu_20.04-*.deb"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneDebFS_arm64_U20_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-ARM64-Ubuntu_20.04-*.deb"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneRpmFS_x8664_C7_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-CentOS_7-*.rpm"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneRpmFS_x8664_RHEL7_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-RHEL_7-*.rpm"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneRpmFS_x8664_RHEL8_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-RHEL_8-*.rpm"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneRpmFS_x86_64_AmazonLinux2_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-AMAZONLINUX_2-*.rpm"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneTarFS_x8664_W19_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-WindowsServer_2019-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneTarFS_x8664_MacOS13_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-x86_64-MacOS_13.5-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildPlaneTarFS_arm64_MacOS12_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/buildPlane-ARM64-MacOS_12-*.tar.gz"
      props: vcs.branch={{gitBranch}}
      recursive: false

  - name: buildImageInputJsonFS_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/buildPlane/${RELEASE_VERSION}-buildplaneImages.json"
      flat: true
      recursive: false

  - name: imageDistr_1
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$

  - name: extensionsJsonFS_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipe-extensions/extensions/*/jfrog_dev/*/*/*.tar.gz"
      recursive: false

  - name: reqkickBuildImage_1
    type: Image
    configuration:
      registry: entplus_jfrog_io_docker
      sourceRepository: jfrog-docker
      imageName: entplus.jfrog.io/pipelines-docker-release-local/jfrog/pipelines-node16-build-base
      imageTag: {{ .Values.baseImageVersion }}

  - name: reqkickRunImage_1
    type: Image
    configuration:
      registry: entplus_jfrog_io_docker
      sourceRepository: jfrog-docker
      imageName: entplus.jfrog.io/pipelines-docker-release-local/jfrog/pipelines-reqkick-base
      imageTag: {{ .Values.baseImageVersion }}

  - name: reqkickImageBI_1
    type: BuildInfo
    configuration:
      sourceArtifactory: entplus_deployer

  - name: reqkickPromotedImageBI_1
    type: BuildInfo
    configuration:
      sourceArtifactory: entplus_deployer

  - name: dindImageBI_1
    type: BuildInfo
    configuration:
      sourceArtifactory: entplus_deployer

  - name: dindPromotedImageBI_1
    type: BuildInfo
    configuration:
      sourceArtifactory: entplus_deployer

  - name: reqkickRB_1
    type: ReleaseBundle
    configuration:
      sourceDistribution: pipe_distribution
      name: "pipelines_reqkick"
      version: "1"
      isSigned: true

  - name: dindRB_1
    type: ReleaseBundle
    configuration:
      sourceDistribution: pipe_distribution
      name: "pipelines_dind"
      version: "1"
      isSigned: true

  - name: artifactsRelease
    type: ReleaseBundle
    configuration:
      sourceDistribution: pipe_distribution
      name: "pipelines_artifacts"
      version: "1"
      isSigned: true       

  - name: dindAQL_1
    type: Aql
    configuration:
      sourceArtifactory: entplus_deployer
      query: items.find({"$and":[{"@build.name":{"$eq":"pipelines-dind"}},{"@build.number":{"$eq":"${build_version}"}}]})
      mappings:
        - name: pipelines-docker_release
          input: pipelines-docker-release-local/(.*)
          output: reg2/$1

  - name: reqkickAQL_1
    type: Aql
    configuration:
      sourceArtifactory: entplus_deployer
      query: items.find({"$and":[{"@build.name":{"$eq":"pipelines-reqkick"}},{"@build.number":{"$eq":"${build_version}"}}]})
      mappings:
        - name: pipelines-docker_release
          input: pipelines-docker-release-local/(.*)
          output: reg2/$1

  - name: arifactAQL
    type: Aql
    configuration:
      sourceArtifactory: entplus_deployer
      query: items.find({"repo":"pipelines-artifacts","name":{"$match":"buildPlane-*-${RELEASE_VERSION}.*"}})
      mappings:
        - name: pipelines-artifacts-release
          input: pipelines-artifacts/buildPlane/(.*)
          output: pipelines/installer/reqick/${RELEASE_VERSION}/$1

  - name: releasesDR_1
    type: DistributionRule
    configuration:
      sourceDistribution: pipe_distribution
      serviceName: "*"
      siteName: releases.jfrog.io
      cityName: "*"
      countryCodes:
        - "*"

  - name: baseImageJsonFile_1
    type: FileSpec
    configuration:
      sourceArtifactory: entplus_deployer
      pattern: "pipelines-artifacts/imagebuilds/base-images/${baseMachineImageVersion}/${provider}/${region}/${osType}/image.json"
      recursive: false
      flat: true

  - name: pipelinesCoreVersion
    type: PropertyBag
    configuration:
      PIPELINES_CORE_VERSION: dummy

  - name: buildCI
    type: GitRepo
    configuration:
      path: PIP/controlplane
      gitProvider: JFrog_bitbucket
      branches:
        include: ^{{gitBranch}}$
      files:
        include: \bbuild\/ci\/.+\b
    
  - name: buildStatusUpdate
    type: PropertyBag
    configuration:
      runId: ""
